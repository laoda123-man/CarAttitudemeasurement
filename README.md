# OPENCV巡线小车
STM32 CarAttitudemeasurement
本课设在实现蓝牙控制智能小车的基础之上，使用了MATLAB制作了一款GUI界面的上位机用于控制小车运动同时观察运动数据。该上位机实现了使用蓝牙连接智能小车，连接后可以实时修改智能车运行的控制参数、可以根据接收的数据实时显示小车当前的运行数据，并可以实现将数据的波形绘制在设定的窗口上。上位机上预留了可以连接后端的接口，可以实现通过上位机的中转达成远程控制。本文设计的上位机可以在线方便的通过进度条和文本框调整电机和舵机的 PID 参数，在修改后可以直接在绘图窗口查看小车运行数据的波形变化，判断所修改的参数是否合理。上位机还可以设置小车运行速度控制小车的启停，实现对小车运行的数据进行统计分析。而且智能车上搭载了一款六轴的MPU6050传感器，根据获得 IMU 数据可以对小车的运行轨迹实现重构。同时使用OPENMV进行赛道巡线。根据仿真和实际测试的验证，本设计功能都已达到，该上位机对智能车的运动控制和转向控制方法的调试具有重要的辅助作用。
1  绪论
1.1综合设计题目要求
（1）能用串口调试助手接收到智能小车的实时数据，编写和调试上位机代码，接收小车数据编写和调试上位机代码，把接收到的数据分类直观显示出来；
（2）对三轴加速度和陀螺仪传感器数据进行预处理，以获得更好的智能小车位姿估计；
（3）编写上位机软件，利用位姿估计和电机编码器信息重构小车的运动轨迹并显示出来；
（4）能准确给出智能小车跑赛道一圈的完整运动轨迹，并得到相应位置上的位姿信息；
（5）智能小车PID控制优化、实时数据统计分析；
（6）编写上位机代码对收集到的实时数据进行统计分析，直观显示舵机控制量与传感器偏离中心值之间、电机控制量与传感器偏离中心值之间的关系曲线图；
（7）修改PID控制策略，使舵机控制量与传感器偏离中心值之间、电机控制量与传感器偏离中心值之间的关系曲线分别为近似线性函数关系曲线、近似二次函数关系曲线，并比较两种控制策略之间的性能优劣；
（8）智能小车能提高车速，快速跑完整个赛道；能直观显示各关系曲线图。
1.2 论文主要内容和框架
使用了一款科学计算软件MATLAB制作了一款GUI界面的上位机。该上位机实现了使用蓝牙连接智能小车，连接后可以实时修改智能车运行的控制参数、可以根据接收的数据实时显示小车当前的运行数据，并可以实现将数据的波形绘制在设定的窗口上。上位机预留了可以连接后端的接口，可以实现通过上位机的中转达成远程控制。 
 

                         （整体框架） 
2  小车运动学建模与运动轨迹推算
小车运动学建模与运动轨迹推算在机器人学、自动驾驶和控制工程等领域有着广泛的应用。本文将详细介绍小车的阿克曼运动学正解与逆解，并进一步探讨如何进行运动轨迹的推算。为了便于理解，我们将尽可能使用简单明了的公式。
基本参数
车轮基距 ( L )：前后车轴之间的距离。
前轮距 ( W )：前轮之间的距离。
转向角 ( heta )：前轮相对于车体中心线的转角。
前轮内侧转角 ( \delta_i ) 和外侧转角 ( \delta_o )。
根据阿克曼几何原理，前轮内外侧转角关系如下： [ an(\delta_i) = \frac{L}{R - \frac{W}{2}} ] [ an(\delta_o) = \frac{L}{R + \frac{W}{2}} ] 其中，( R ) 是小车转弯的半径。
运动学方程
假设小车的纵向速度为 ( v )，根据阿克曼转向几何，车辆瞬时的转动中心在后轴的延长线上，距离车后轴中心点 ( R ) 处。因此，小车的角速度 ( \omega ) 可表示为： [ \omega = \frac{v}{R} ]
结合前轮转角与转向半径的关系，可以得到： [ R = \frac{L}{    an(    heta)} ]
因此，角速度可表示为： [ \omega = \frac{v \cdot     an(    heta)}{L} ]
根据以上公式，车辆的运动状态可以通过以下运动学方程描述： [ \dot{x} = v \cos(\phi) ] [ \dot{y} = v \sin(\phi) ] [ \dot{\phi} = \frac{v \cdot     an(    heta)}{L} ] 其中，( (x, y) ) 是小车在二维平面上的位置，( \phi ) 是小车的航向角。

2.1小车运动学建模
2.1.1阿克曼运动学正解
阿克曼运动学模型是专门为四轮小车设计的一种运动学模型，它能够有效地描述小车在二维平面上的运动。阿克曼转向几何的核心思想是确保前轮内外侧的转角不同，以避免轮胎滑动，从而使车辆在转弯时能够沿正确的轨迹行驶。


2.1.2阿克曼运动学逆解
阿克曼运动学逆解是指给定小车的运动轨迹，求解相应的转向角和速度。这在路径规划和自动驾驶中尤为重要。

表4.1 智能小车元件清单
模块名	型号
视觉巡线模块	OPENMV
测速模块	编码器
蓝牙模块	HC05
WIFI模块	pyWiFi-ESP32（主控板）
三轴加速度+三轴
陀螺仪一体模块	MPU6050  
电机	520编码器电机
	
2.2运动轨迹推算
在实际应用中，运动轨迹推算通常是指根据小车的初始状态和控制输入，推算小车在未来的运动轨迹。我们可以通过数值积分的方法来实现这一目标。
假设我们有一个目标轨迹，表示为 ( (x_d(t), y_d(t)) )，对应的航向角为 ( \phi_d(t) )。为了使小车沿着该轨迹运动，我们需要调整前轮转角 (     heta ) 和纵向速度 ( v )。
首先，定义小车相对于目标轨迹的横向误差 ( e_y ) 和航向误差 ( e_\phi )： [ e_y = (x_d - x) \sin(\phi_d) - (y_d - y) \cos(\phi_d) ] [ e_\phi = \phi_d - \phi ]
为了实现路径跟踪，可以采用比例-微分（PD）控制器对横向误差和航向误差进行反馈控制。设定控制律为： [ v = v_d ] [ heta = \arctan\left(\frac{L \cdot \omega_d + kp \cdot e_y + kd \cdot \dot{e}_y}{v_d}\right) ] 其中，( vd ) 和 ( \omega_d ) 分别是目标轨迹的纵向速度和角速度，( kp ) 和 ( kd ) 是控制增益。
数值积分
假设在时间 ( t ) 时刻，小车的状态为 ( (x(t), y(t), \phi(t)) )，给定前轮转角 (     heta(t) ) 和速度 ( v(t) )，我们可以在一个小时间步长 ( \Delta t ) 内，使用欧拉法进行数值积分：
[ x(t + \Delta t) = x(t) + \Delta t \cdot v(t) \cos(\phi(t)) ] [ y(t + \Delta t) = y(t) + \Delta t \cdot v(t) \sin(\phi(t)) ] [ \phi(t + \Delta t) = \phi(t) + \Delta t \cdot \frac{v(t) \cdot     an(    heta(t))}{L} ]
通过迭代上述步骤，可以推算小车在未来一段时间内的运动轨迹。
小车从初始状态 ( (x_0, y_0, \phi_0) ) 出发，给定恒定的前轮转角 (     heta ) 和速度 ( v )，我们可以计算未来 ( N ) 个时间步长内的小车运动轨迹：
import numpy as np
import matplotlib.pyplot as plt
import numpy as np
import matplotlib.pyplot as plt

# 初始化参数
L = 2.5  # 车轮基距
x0, y0, phi0 = 0, 0, 0  # 初始状态
theta = np.radians(30)  # 前轮转角（弧度）
v = 2  # 速度（m/s）
delta_t = 0.1  # 时间步长（秒）
N = 100  # 时间步长数量

# 初始化状态变量
x, y, phi = x0, y0, phi0
trajectory = [(x, y)]

# 数值积分计算运动轨迹
for _ in range(N):
    x += delta_t * v * np.cos(phi)
    y += delta_t * v * np.sin(phi)
    phi += delta_t * (v * np.tan(theta) / L)
    trajectory.append((x, y))

# 绘制运动轨迹
trajectory = np.array(trajectory)
plt.plot(trajectory[:, 0], trajectory[:, 1], label='Trajectory')
plt.xlabel('X position (m)')
plt.ylabel('Y position (m)')
plt.title('Vehicle Trajectory')
plt.legend()
plt.show()

 
图2.1 设计方案框图

2.3 本章小结
本文详细介绍了小车运动学建模与运动轨迹推算的基本理论和计算方法。通过阿克曼运动学正解，可以计算出各车轮的转向角度，确保车辆沿理想轨迹行驶。通过逆解，可以根据给定的轨迹求出所需的转向角度。最后，通过数值积分方法推算小车的运动轨迹，实现路径规划和控制。阿克曼运动学模型在实际应用中有着广泛的应用前景，对于自动驾驶和智能机器人导航系统的设计与实现具有重要的指导意义。


3  运动控制规律统计分析
3.1 偏离中心值与电机编码脉冲的统计关系 
3.1.1近似线性函数控制规律的散点图
如图所示。
 3.1.2 近似二次函数控制规律的散点图
如图所示。
 
3.2 偏离中心值与舵机角度的统计关系
3.2.1 近似线性函数控制规律的散点图
 
近似线性函数控制规律的散点图
 
（数据发送流程图）

3.3 本章小结
通过上述散点图的分析，我们可以得出智能巡线小车的偏离中心值与舵机角度之间存在显著的近似线性关系。这种关系表明小车能够根据偏离中心的位置，通过调整舵机角度实现自动纠偏，从而保持在预设路径上。这个分析对优化小车的控制算法，提高其巡线能力具有重要意义。
通过分析智能巡线小车的偏离中心值与电机编码脉冲的两种关系散点图，我们得出不同类型的关系可以用于不同复杂度的控制算法。线性关系适用于简单快速的调整，而二次函数关系则可以用于更复杂的纠偏情况，提高小车的巡线稳定性和准确性。这为优化小车的控制算法提供了重要的依据和方向。
 
4  GUI上位机程序设计
4.1 GUI上位机功能介绍
本课设主要使用MATLAB来编写一个GUI界面的上位机。研究的内容有：设计合适的窗口用于数据和波形的展示； 设计合适的控件用于调整小车的PID参数；可以对收集的数据进行分析等。文章中使用到的智能小车是使用OPENMV模块循迹的，并且增加了九轴传感器模块， 用于采集加速度、陀螺仪和磁力计数据。智能车的SMT32主控通过JDY_31蓝牙模块与上位机通讯，将小车的左右编码器脉冲值、循迹传感器值、PID 控制参数、电机和舵机控制值、IMU 数据（包括加速度、陀螺仪和磁力计）和其他速度参数等实时数据上传到上位机，上位机会对这些数据进行分析。
本文设计的GUI上位机可以在线方便的通过进度条和文本框调整电机和舵机的 PID 参数，在修改后可以直接在绘图窗口查看小车运行数据的波形变化，并且通过坐标轴显示小车的实时数据，并判断所修改的参数是否合理。上位机还可以设置小车运行速度控制小车的启停，同时对对小车运行的数据进行统计分析，包含有电机响应，舵机响应，以及轨迹重构等功能。而且智能车上搭载了openmv，用以进行赛道巡线，同时用六轴的MPU6050传感器，根据获得 IMU 数据可以对小车的运行轨迹实现重构。
 
( 上位机功能框图)
4.2 主要功能实现
4.2.1 PID控制参数在线调节
需要调整的参数共有7个，分别是电机的PID三个参数、舵机的PID三个参数和小车的车速。为了更加便捷的控制上述这几个参数，使用滑动条和直接输入数据两种方式 进行控制。设计时使用“静态文本”、“可编辑文本”和“滑动条”来配合，设计好的参数控制界面如图所示。
 
图中参数调节界面中的当前值为部分没有显示的数据，如pid等参数。滑动条的最大值和最小值可以在滑动条的属性中通过修改的为其“Max”和“Min”来设置，滑动条属性栏中的“SliderStep” 可以设置滑动条移动的最小数值。
4.2.2 实时显示数据波形界面的实现
数据波形显示的界面用MATLAB GUI中的“坐标区”绘制，直接修改到合适的大小，最后修改一下标签。界面如图所示。
 
4.2.3 实时显示数据界面的实现
上位机需要对小车数据进行展示。使用“静态文本”和 “可编辑文本”配合创建。为了配合4.2.2的数据波形绘制，将需要绘制波形的数据使用“复选框”来进行提示。这样既可做到提示这个数据的类型，也可做的配合数据的波形绘制，当需要绘制某个数据的波形时，选中复选框即可。为了整体的界面更加美观， 将上位机接收的pid反馈参数数据放到4.2.1节的参数调节部分进行显示。主要显示数据的界面如图所示。 
  
4.2.4 连接串口界面的实现
串口界面按照使用串口时需要配置的参数来设置。通常使用一个串口，需要知道其串口号，波特率、检验位、停止位等。一般来说修改比较多的是串口号和波特率，其它参数一般使用默认的参数。所以设计这个串口界面就需要有串口号的选择和波特率以及其他参数的选择，这写参数通过选择MATLAB GUI界面中的“弹出式菜单”来进行布局，改变‘string’参数来显示这些参数，方便知道具体每个菜单的功能。当参数选择完成后，我们需要一个按键来进行打开串口，所以需要添加一个“按钮”。GUI 中按钮的类型是有多种的，串口是要实现既能打开也能关闭,所以需要将按钮的类型修改为“togglebutton”类型，这种类型的按键会有两种状态，可较为方便的实现“打开、 关闭”功能。设置好的界面如图所示。
 
为了方便记忆和后续的调试，在串口选择菜单的属性检查器中将其标签（Tag）修 改为“PORT”，如图所示。同理修改波特率选择菜单、指示灯和打开串口按钮的标签为便于记忆的名称。
 


4.2.5 手动控制界面的实现
通过开启按钮开启手动操作模式后，可以控制小车的前进后退左转右转等操作，如图所示。
 
4.2.6 功能选择和其它部分界面的实现
 
如图展示的是上位机剩余的其余功能，其中的功能选择区域是负责对小车运行完一圈后的数据进行收集处理，这些数据用于做电机响应分析、舵机响应分析以及轨迹重建。由于小车每次发送的数据是连续写入一个文件的，为此添加了一个可以“新建文件” 的按钮，可以使用该按钮来新建一个txt 文件用于保存小车的运行数据。获取数据按钮是为了获取保存在小车上的数据，在连接上小车后可以通过该按钮获取数据。“启动”按钮是用于发送启动命令给小车，使其启动循迹模式。同时，该按钮也是为“togglebutton”类型的按钮，为了在启动后可以停止小车。 图中的“暂停显示”和“清空显示”的按钮是针对 4.2.3 节数据波形绘制和 4.2.4节数据显示的功能而设置的。暂停显示功能可以使上位机在接收数据的过程中暂停数据显示和数据波形绘制的更新。可以实现在正常接收数据的情况下，暂停以观看当前数据。 而清空显示功能是用于清空页面上展示的波形和数据。图中还有一个“本次运行数据” 的复选框，该复选框为为了分析已经保存的数据文件。在不勾选时，使用任意一个功能选择区域的按钮时可实现弹出文件选择界面，用于选择已保存的文件来进行分析。
 

4.2.7 上位机整体布局
如图所示。
 
4.2.8 重构轨迹及其误差分析
根据王艺辉等的思路[11]当采集数据的间隔够短时，可以根据两个点之间的速度和角度计算出这段时间的大概运行轨迹。六轴数据使用 IMU 传感器进行收集，传感器的具体的型号为MPU6050。按原理来说,由于陀螺仪存在零偏和较大的噪声[12]，当使用陀螺仪对长时间运行的运行轨迹进行重建会出现轨迹不能重合的现象，但如果按照小车在赛道跑动一圈的时间来进行轨迹重构是可以正常绘制出来的。 
如图所示，该图为陀螺仪重构轨迹。
 
该图是根据陀螺仪计算重构出来的轨迹，从图中可以看到已经重构出赛道的大致轨迹，但由于存在一定的偏差，导致轨迹不能重合，经过对offset_x和offset_y 的值以及控制周期进行矫正后可以得到图所示的重构轨迹，该轨迹图已经基本完成了轨迹的闭合。
 

4.3  本章小结
使用 MATLAB 制作一个用于智能车在线整定 PID 参数上位机是可行的，借助于 MATLAB 强大的数据计算功能和自带的各种函数，可以快速的实现对接收的数据进行 分析，得出小车当前的运行状态的好坏和需要调整优化的地方。根据小车运行的数据还可对小车的轨迹运行轨迹进行重构，如果知道小车启动的具体坐标和空间的具体大小， 还可以根据轨迹重建的思路实现低精度的平面定位。 该上位机设计的第一个重点在于实现使用蓝牙连接上位机，实现可以接收和发送数 据，并且可以通过蓝牙的回调将接收的数据进行保存和展示，其余的功能大都是用于实现对已接收到的数据进行分析。实现了这个功能小车的主体就有了。其余的就是对小车所需的功能进行添加。
该上位机的设计已经完成智能车的数据的实时展示，可以对数据的波形进行绘制，实现了对接收的数据进行电机响应、舵机响应的数据分析，并且实现了可以根据收集的数据对小车的循行轨迹进行重构，而且实现可以通过上位机的控件控制小车的运动状态和运动时的控制参数。
